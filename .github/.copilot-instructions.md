# GitHub Copilot Instructions for jest-parallel-worker

## Repository Overview

This is **jest-parallel-worker**, a Node.js SDK that extends Jest to run tests in parallel at the test level, providing significant performance improvements and detailed reporting capabilities. The project includes both CLI tools and programmatic SDK interfaces.

## Project Architecture

### Core Structure
```
src/
├── core/           # Core execution engine
│   ├── runner.js              # Main test runner orchestration
│   ├── worker-manager.js      # Worker process management & timeout handling
│   ├── parser.js              # Jest test file parsing & AST analysis
│   ├── reporter.js            # HTML/JSON report generation
│   └── execution-logger.js    # Detailed execution logging
├── workers/        # Worker process implementations
│   ├── native-parallel-worker.js    # Native Jest execution with BrowserStack support
│   ├── concurrent-file-worker.js    # File-level concurrent execution
│   ├── concurrent-test-worker.js    # Test-level concurrent execution
│   └── test-worker.js               # Individual test execution
├── utils/          # Utility functions
│   └── logger.js              # Logging infrastructure
├── integrations/   # Third-party integrations
│   └── browserstack.js       # BrowserStack Node SDK integration
└── index.js        # Main SDK export
```

### Key Components

1. **JestParallelRunner**: Main orchestrator that coordinates test execution
2. **WorkerManager**: Manages worker processes, timeouts, and execution modes
3. **TestParser**: AST-based parsing of Jest test files to extract test metadata
4. **ReportGenerator**: Creates detailed HTML and JSON reports with metrics
5. **Workers**: Different execution strategies (native, concurrent, individual)

## Execution Modes

The system supports 4 execution modes:

1. **`native-parallel`** (Default): Uses Jest's native parallel capabilities with file-level processes
2. **`parallel-files`**: File-level parallelism with custom worker management
3. **`parallel-tests`**: Individual test-level parallelism (rewrites tests to concurrent)
4. **`concurrent-files`**: Transforms regular tests to concurrent within files

## Key Features & Integration Points

### BrowserStack Integration
- **Environment Detection**: Uses `process.env.BROWSERSTACK_SDK_ENABLED` or `--browserstack-sdk` flag
- **Build ID Management**: Generates unified build IDs across all parallel workers
- **SDK Wrapping**: Executes tests through `browserstack-node-sdk jest` instead of direct `jest`
- **Output Parsing**: Enhanced parsing for BrowserStack SDK output format differences

### Timeout Handling
- **Multi-Level Timeouts**: WorkerManager, Individual Workers, and Jest process timeouts
- **User-Specified Timeouts**: Respects `--timeout` parameter (in minutes, converted to milliseconds)
- **Jest Timeout Parameters**: Uses `--testTimeout` to constrain Jest execution time
- **Process Cleanup**: SIGTERM followed by SIGKILL for stuck processes

### Hook Support & Timing
- **Hook Duration Calculation**: Estimates beforeAll, beforeEach, afterAll, afterEach timing
- **BrowserStack Hook Metrics**: Special handling for BrowserStack output parsing
- **Nested Describe Blocks**: Proper parsing of nested test suites and their hooks

## Development Guidelines for Copilot

### Code Style & Patterns

1. **Async/Await**: Prefer async/await over Promises where possible
2. **Error Handling**: Always wrap async operations in try-catch blocks
3. **Logging**: Use structured logging with context (workerId, filePath, timing)
4. **Process Management**: Always handle process cleanup and timeout scenarios

### Worker Process Patterns

When creating or modifying workers:

```javascript
// Standard worker timeout pattern
const timeoutId = setTimeout(() => {
  if (!worker.killed) {
    worker.kill('SIGKILL');
    this.executionLogger.logWorkerTimeout(workerId, `Exceeded ${this.formatDuration(this.timeout)} timeout limit`);
    this.logger.warn(`Worker ${workerId} killed due to timeout`);
  }
}, this.timeout);

worker.on('close', (code) => {
  clearTimeout(timeoutId);
  // Handle completion
});
```

### Jest Command Construction

Always include timeout constraints when spawning Jest:

```javascript
const jestArgs = [
  '--testMatch', `${workItem.filePath}`,
  '--verbose',
  '--no-coverage',
  '--runInBand',
  '--passWithNoTests=false',
  '--testTimeout', this.timeout.toString()  // Critical for timeout enforcement
];

// BrowserStack conditional execution
const cmd = 'npx';
const cmdArgs = useBrowserStack ? ['browserstack-node-sdk', 'jest', ...jestArgs] : ['jest', ...jestArgs];
```

### Output Parsing Patterns

Jest output parsing should handle both regular and BrowserStack formats:

```javascript
// Multi-strategy parsing approach
const parseResult = this.parseJestOutput(combinedOutput, workItem);
const testResults = parseResult.testResults || parseResult;
const hookInfo = parseResult.hookInfo || {};

// Hook duration calculation with BrowserStack fallback
this.calculateHookDurations(overallSuiteDuration, totalTestDuration, testResults, hookInfo, workItem);
```

### Configuration Handling

Always respect user configuration and provide sensible defaults:

```javascript
constructor(options, logger, executionLogger) {
  this.options = options; // Store full options for worker configuration
  this.maxWorkers = options.maxWorkers || 4;
  this.timeout = options.timeout || (5 * 60 * 1000); // Default 5 minutes in milliseconds
  this.browserstackSdk = options.browserstackSdk || false;
}
```

## Integration Considerations

### BrowserStack SDK
- **Performance Impact**: BrowserStack adds network overhead and process wrapping
- **Output Differences**: Different timing formats and error message structures
- **Build Management**: Unified build IDs prevent fragmented test reports
- **Environment Variables**: Propagate `BROWSERSTACK_BUILD_ID` to all worker processes

### Jest Compatibility
- **Version Requirements**: Supports Jest >=29.0.0
- **Configuration**: Respects existing jest.config.js files
- **Test Discovery**: Uses Jest's test matching patterns
- **Reporter Integration**: Can coexist with Jest's built-in reporters

### CLI Integration
- **Commander.js**: Uses commander for CLI argument parsing
- **Configuration Files**: Supports JSON configuration files
- **Environment Variables**: Respects standard Jest environment variables

## Common Patterns & Anti-Patterns

### ✅ Good Patterns

1. **Structured Logging**:
```javascript
this.logger.debug(`Worker ${workerId} processing ${path.basename(workItem.filePath)}`);
this.executionLogger.logWorkerStart(workerId, workItem);
```

2. **Timeout Management**:
```javascript
// Always use unique timeout IDs to avoid conflicts
const testWorkerTimeoutId = setTimeout(() => { /* cleanup */ }, timeout);
clearTimeout(testWorkerTimeoutId);
```

3. **Error Classification**:
```javascript
const { errorMessage, failureType, hookType } = this.classifyJestError(errorText, suiteName);
```

### ❌ Anti-Patterns

1. **Hardcoded Timeouts**: Never use fixed timeout values, always respect user configuration
2. **Missing Cleanup**: Always clear timeouts and kill processes on completion
3. **Synchronous Operations**: Avoid blocking operations in worker coordination
4. **Silent Failures**: Always log errors and provide meaningful error messages

## Testing Patterns

When adding new features or workers:

1. **Test with BrowserStack**: Verify both regular Jest and BrowserStack SDK execution
2. **Timeout Scenarios**: Test timeout handling with short timeouts
3. **Hook Behavior**: Verify beforeAll/afterAll hooks work correctly
4. **Error Handling**: Test malformed Jest output and process failures
5. **Report Generation**: Ensure HTML and JSON reports are generated correctly

## Performance Considerations

1. **Worker Pool Management**: Balance parallelism with system resources
2. **Memory Usage**: Monitor Node.js heap usage in worker processes
3. **Process Cleanup**: Ensure worker processes terminate properly
4. **Output Buffer Management**: Handle large Jest output efficiently

## File-Specific Context

### `worker-manager.js`
- Central coordinator for all worker processes
- Handles timeout enforcement at multiple levels
- Manages BrowserStack integration and build ID coordination
- Responsible for test status tracking and progress reporting

### `native-parallel-worker.js`
- Individual worker process implementation
- Supports both regular Jest and BrowserStack SDK execution
- Handles Jest output parsing and result formatting
- Implements timeout constraints and process cleanup

### `parser.js`
- AST-based test file analysis
- Extracts test metadata without executing code
- Identifies hooks, describe blocks, and test functions
- Provides test counting and discovery capabilities

### `reporter.js`
- Generates comprehensive HTML and JSON reports
- Includes performance metrics and visualizations
- Supports multiple output formats and customization
- Integrates with execution logging for detailed insights

This repository is actively developed with focus on performance, reliability, and seamless Jest integration. When contributing, prioritize backward compatibility and comprehensive error handling.
